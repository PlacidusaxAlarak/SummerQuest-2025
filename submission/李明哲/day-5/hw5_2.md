# 答题卡

## 1 总训练时间与理想时间

### 1.1
**推导过程：**
- 前向传播阶段：
  - 第一个 microbatch 需要经过所有 $p$ 个阶段：$p \times t_f$
  - 后续 $(m-1)$ 个 microbatch 可以流水线执行，每个额外需要 $t_f$
  - 前向总时间：$p \times t_f + (m-1) \times t_f = (p + m - 1) \times t_f$

- 反向传播阶段：
  - 类似地，反向传播总时间：$(p + m - 1) \times t_b$

**总执行时间表达式：**
$$T_{\text{total}} = (p + m - 1) \times (t_f + t_b)$$

**数值计算：**
$$T_{\text{total}} = (4 + 8 - 1) \times (2 + 4) = 11 \times 6 = 66 \text{ ms}$$

### 1.2
理想执行时间（没有流水线空泡的情况）：
$$T_{\text{ideal}} = m \times (t_f + t_b) = 8 \times (2 + 4) = 8 \times 6 = 48 \text{ ms}$$

### 1.3
Bubble Ratio 计算：
$$\text{Bubble Ratio} = \frac{T_{\text{total}}}{T_{\text{ideal}}} = \frac{66}{48} = 1.375$$

这意味着由于流水线空泡，实际执行时间比理想时间多了 37.5%。

## 2 若将 microbatch 数增加为 $m = 16$，bubble ratio 会如何变化？请分析并说明原因

当 $m = 16$ 时：
- $T_{\text{total}} = (4 + 16 - 1) \times 6 = 19 \times 6 = 114 \text{ ms}$
- $T_{\text{ideal}} = 16 \times 6 = 96 \text{ ms}$
- $\text{Bubble Ratio} = \frac{114}{96} = 1.1875$

**变化分析：**
- Bubble ratio 从 1.375 降低到 1.1875，效率提升
- 空泡时间占比从 37.5% 降低到 18.75%

**原因：**
1. 空泡时间主要来自流水线的启动和排空阶段，这部分时间是固定的：$(p-1) \times (t_f + t_b)$
2. 增加 microbatch 数量增加了有效计算时间，但空泡时间保持不变
3. 因此，空泡时间占总时间的比例降低，流水线利用率提高
4. 当 $m \to \infty$ 时，$\text{Bubble Ratio} \to 1$，但实际中受限于内存和其他因素

## 3. 与 Gpipe 相比，1F1B 调度策略在哪些方面优化了流水线利用率？

1. **减少内存占用：**
   - Gpipe 需要保存所有 $m$ 个 microbatch 的中间激活直到反向传播开始
   - 1F1B 在完成一个前向后立即执行对应的反向，及时释放激活内存
   - 峰值内存从 $O(m)$ 降低到 $O(p)$

2. **更均匀的计算分布：**
   - Gpipe 中存在明显的前向阶段和反向阶段，导致设备在某些时刻空闲
   - 1F1B 交错执行前向和反向，使各个设备的工作负载更均衡

3. **减少空泡时间：**
   - 1F1B 的空泡主要在开始的预热阶段和结束的冷却阶段
   - 中间阶段可以保持稳定的 1F1B 节奏，减少了总体空泡时间
   - 对于相同的 $p$ 和 $m$，1F1B 通常有更低的 bubble ratio

4. **更好的扩展性：**
   - 由于内存占用更少，1F1B 可以支持更大的 microbatch 大小或更多的 microbatch 数量
   - 这进一步提高了计算效率和 GPU 利用率

5. **更灵活的调度：**
   - 1F1B 的交错模式为进一步的优化提供了空间，如优先级调度、动态负载均衡等 